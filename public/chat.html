<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math GPT â€” Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0c10; --panel:#141720; --text:#e9edf5; --muted:#9aa3b2; --brand:#5b8cff;
      --border:#232635; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    body{display:flex;overflow:hidden;}
    /* Sidebar */
    #sidebar{width:240px;background:#10121a;border-right:1px solid var(--border);display:flex;flex-direction:column;}
    #sidebar h3{padding:16px 12px;margin:0;border-bottom:1px solid var(--border);}
    #history{flex:1;overflow-y:auto;padding:8px;}
    .history-item{padding:10px 12px;border-bottom:1px solid #1e2130;cursor:pointer;font-size:14px;color:var(--muted);}
    .history-item:hover{background:#1b2030;color:var(--text);}
    .clear-btn{margin:8px;border:none;background:#1b2030;border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer;}
    .clear-btn:hover{background:#252b40;}
    /* Chat area */
    .chat-container{flex:1;display:flex;flex-direction:column;height:100vh;padding:16px;}
    .header{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);}
    .brand{font-weight:800;font-size:18px;display:flex;align-items:center;gap:10px;}
    .badge{font-size:12px;color:#cce7ff;background:#0f1b33;border:1px solid #1f2a44;padding:2px 8px;border-radius:999px}
    .substatus{font-size:12px;color:var(--muted)}
    .notice{margin:8px 0 0;border:1px solid var(--border);background:#101425;border-radius:10px;padding:8px 10px;font-size:13px;color:#9db3ff;display:none}
    .chat-window{flex:1;overflow-y:auto;padding:12px;scroll-behavior:smooth;}
    .msg{max-width:80%;margin-bottom:14px;padding:12px 14px;border-radius:var(--radius);word-break:break-word;line-height:1.5;font-size:15px;}
    .user-msg{background:#1c2333;margin-left:auto;border:1px solid #2b2f3c;}
    .bot-msg{background:var(--panel);border:1px solid var(--border);margin-right:auto;white-space:pre-wrap}
    .chat-input{display:flex;gap:8px;align-items:center;border-top:1px solid var(--border);padding:12px 0;}
    textarea{flex:1;background:#0e1320;border:1px solid var(--border);border-radius:var(--radius);color:var(--text);padding:12px;font-family:inherit;font-size:15px;resize:none;min-height:48px;max-height:150px;}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:var(--radius);padding:12px 18px;font-weight:600;cursor:pointer;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    #imageInput{display:none;}
    .upload-label{background:#1b2030;border:1px solid var(--border);padding:10px;border-radius:var(--radius);cursor:pointer;}
    .download-btn{background:#1b2030;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:13px;margin-top:8px;display:none;}
    .download-btn:hover{background:#252b40;}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999;}
    .modal-content{background:var(--panel);border:1px solid var(--border);padding:24px;border-radius:var(--radius);max-width:360px;text-align:center;}
    .modal button{margin-top:16px;background:var(--brand);color:#fff;border:none;padding:10px 16px;border-radius:var(--radius);cursor:pointer;}
    @media(max-width:900px){#sidebar{display:none;}.chat-container{padding:10px;}}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <h3>Saved Solutions</h3>
    <div id="history"></div>
    <button class="clear-btn" id="clearHistory">Clear All</button>
  </aside>

  <!-- Main Chat -->
  <div class="chat-container">
    <div class="header">
      <div class="brand">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M12 3l7.794 4.5v9L12 21 4.206 16.5v-9L12 3z" stroke="#5b8cff"/></svg>
        Math GPT
        <span class="badge">GPT-4</span>
      </div>
      <div>
        <span id="user-email" class="substatus"></span>
        <span id="sub-plan" class="substatus"></span>
      </div>
    </div>

    <div id="notice" class="notice"></div>
    <div id="chat-window" class="chat-window"></div>

    <form id="chat-form" class="chat-input">
      <label for="imageInput" class="upload-label" title="Upload math image">ðŸ“·</label>
      <input type="file" id="imageInput" accept="image/*" />
      <textarea id="prompt" placeholder="Type your math question here..."></textarea>
      <button class="btn" id="sendBtn" type="submit">Send</button>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const chatWindow=document.getElementById('chat-window');
    const chatForm=document.getElementById('chat-form');
    const promptInput=document.getElementById('prompt');
    const imageInput=document.getElementById('imageInput');
    const userEmailDisplay=document.getElementById('user-email');
    const planDisplay=document.getElementById('sub-plan');
    const notice=document.getElementById('notice');
    const historyDiv=document.getElementById('history');
    const clearBtn=document.getElementById('clearHistory');
    const {jsPDF}=window.jspdf;

    // ---------- USER SETUP ----------
    let email=localStorage.getItem('userEmail')||"";
    if(!email){email=prompt("Enter your email:");localStorage.setItem('userEmail',email);}
    userEmailDisplay.textContent=email;

    let solveCount=Number(localStorage.getItem("dailySolves")||0);
    let lastUsed=localStorage.getItem("lastSolveDate")||"";
    const today=new Date().toISOString().split("T")[0];
    if(lastUsed!==today){solveCount=0;localStorage.setItem("dailySolves",0);localStorage.setItem("lastSolveDate",today);}

    // ---------- SUBSCRIPTION ----------
    async function getSubscriptionStatus(){
      try{
        const res=await fetch(`/api/subscription/status/${encodeURIComponent(email)}`);
        if(!res.ok){throw new Error('status '+res.status);}
        const json=await res.json();
        return json; // {status, plan?}
      }catch(_){
        return { status:"free" };
      }
    }

    function setNotice(text){
      if(!text){notice.style.display='none';notice.textContent='';return;}
      notice.innerHTML=text;
      notice.style.display='block';
    }

    // ---------- MESSAGES ----------
    function appendMessage(text,sender="bot"){
      const msg=document.createElement('div');
      msg.className=sender==='user'?'msg user-msg':'msg bot-msg';
      msg.textContent=text;
      chatWindow.appendChild(msg);
      chatWindow.scrollTop=chatWindow.scrollHeight;
      return msg;
    }

    // ---------- MODAL ----------
    function showUpgradeModal(){
      const modal=document.createElement('div');
      modal.className='modal';
      modal.innerHTML=`
        <div class="modal-content">
          <h3>Youâ€™ve reached todayâ€™s free limit</h3>
          <p>Upgrade to Premium for unlimited problem solving.</p>
          <button id="goUpgrade">Upgrade â‚µ49</button>
          <button id="closeModal" style="background:#1b2030;border:1px solid var(--border);margin-left:8px;">Close</button>
        </div>`;
      document.body.appendChild(modal);
      document.getElementById('goUpgrade').onclick=()=>{window.location.href='/#pricing';};
      document.getElementById('closeModal').onclick=()=>modal.remove();
    }

    // ---------- PDF ----------
    function downloadPDF(q,a){
      const doc=new jsPDF();
      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("Math GPT â€” Solution Report",20,20);
      doc.setFontSize(12);
      doc.setFont("helvetica","normal");
      doc.text(`Date: ${new Date().toLocaleString()}`,20,30);
      doc.text(`User: ${email}`,20,38);
      doc.text("Question:",20,52);
      doc.text(doc.splitTextToSize(q||"[Photo problem]",170),20,60);
      doc.text("Solution:",20,80);
      const lines=doc.splitTextToSize(a||"",170);
      doc.text(lines,20,88);
      doc.save(`MathGPT_Solution_${Date.now()}.pdf`);
    }

    // ---------- LOCAL HISTORY ----------
    function loadHistory(){
      const saved=JSON.parse(localStorage.getItem("mathgpt_history")||"[]");
      historyDiv.innerHTML="";
      saved.forEach((item,i)=>{
        const div=document.createElement('div');
        div.className="history-item";
        div.textContent=item.question.slice(0,40)+(item.question.length>40?"â€¦":"");
        div.onclick=()=>showSavedSolution(i);
        historyDiv.appendChild(div);
      });
    }
    function saveSolution(q,a){
      const saved=JSON.parse(localStorage.getItem("mathgpt_history")||"[]");
      saved.unshift({question:q||"[Photo problem]",answer:a||"",date:new Date().toLocaleString()});
      localStorage.setItem("mathgpt_history",JSON.stringify(saved.slice(0,50)));
      loadHistory();
    }
    function showSavedSolution(index){
      const saved=JSON.parse(localStorage.getItem("mathgpt_history")||"[]");
      const item=saved[index];
      if(!item)return;
      chatWindow.innerHTML="";
      appendMessage(item.question,'user');
      const msg=appendMessage(item.answer,'bot');
      const dl=document.createElement('button');
      dl.className='download-btn';
      dl.textContent='Download PDF';
      dl.onclick=()=>downloadPDF(item.question,item.answer);
      msg.appendChild(dl);
      dl.style.display='inline-block';
      chatWindow.scrollTop=chatWindow.scrollHeight;
    }
    clearBtn.onclick=()=>{if(confirm("Clear all saved solutions?")){localStorage.removeItem("mathgpt_history");loadHistory();}}

    // ---------- CHAT HANDLER ----------
    chatForm.addEventListener('submit',async(e)=>{
      e.preventDefault();
      const message=promptInput.value.trim();
      const imageFile=imageInput.files[0];
      if(!message && !imageFile)return;

      const {status, plan}=await getSubscriptionStatus();
      planDisplay.textContent = status==="active" ? ` â€¢ ${plan || "Premium"} (active)` : ` â€¢ Free tier`;

      // Free-tier gating
      if(status!=="active" && solveCount>=3){
        setNotice(`Free solves used: <b>${solveCount}/3</b>. <a href="/#pricing" style="color:#9db3ff">Upgrade to continue</a>.`);
        showUpgradeModal();
        return;
      }

      appendMessage(message||"[Photo problem]",'user');
      promptInput.value=''; imageInput.value='';
      const imgData=imageFile?await toBase64(imageFile):null;

      const botMsg=appendMessage("Solvingâ€¦",'bot');
      setNotice(status==="active" ? "" : `Free solves used: <b>${solveCount}/3</b>.`);

      try{
        const res=await fetch('/api/chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({email,assistant:'Math GPT',message,image:imgData})
        });

        let data;
        try{ data=await res.json(); }catch(_){ data={}; }

        if(!res.ok){
          const msg = data?.message || data?.error || `HTTP ${res.status}`;
          botMsg.textContent = `Error: ${msg}`;
          return;
        }

        const answer=data.content||"No response.";
        botMsg.textContent=answer;
        saveSolution(message,answer);

        // PDF button
        const dlBtn=document.createElement('button');
        dlBtn.className='download-btn';
        dlBtn.textContent='Download PDF';
        botMsg.appendChild(dlBtn);

        if(status==="active"){ // subscribers
          dlBtn.style.display="inline-block";
          dlBtn.onclick=()=>downloadPDF(message,answer);
          setNotice(""); // remove free-tier banner
        } else {
          dlBtn.style.display="none";
          solveCount++;
          localStorage.setItem("dailySolves",solveCount);
          setNotice(`Free solves used: <b>${solveCount}/3</b>.`);
        }
      }catch(err){
        botMsg.textContent="Error: "+(err?.message||"Request failed");
      }
    });

    function toBase64(file){
      return new Promise((res,rej)=>{
        const reader=new FileReader();
        reader.onload=()=>res(reader.result);
        reader.onerror=rej;
        reader.readAsDataURL(file);
      });
    }

    // INIT
    (async function init(){
      loadHistory();
      const {status, plan}=await getSubscriptionStatus();
      planDisplay.textContent = status==="active" ? ` â€¢ ${plan || "Premium"} (active)` : ` â€¢ Free tier`;
      if(status!=="active"){
        setNotice(`Free solves used: <b>${solveCount}/3</b>. <a href="/#pricing" style="color:#9db3ff">Upgrade for unlimited</a>.`);
      }
    })();
  </script>
</body>
</html>
