<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Math GPT ‚Äî Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0e0f13; --panel:#13141a; --panel2:#0f1117; --muted:#9aa3b2; --text:#e7eaf1; --brand:#5865f2;
      --assistant:#171923; --user:#0e1320; --border:#232634; --radius:14px; --sidebar:280px; --vh:100vh;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .app{display:grid;grid-template-columns:var(--sidebar) 1fr;height:100%}
    /* Sidebar */
    .side{border-right:1px solid var(--border);background:var(--panel2);display:flex;flex-direction:column;min-width:0}
    .side .top{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--border)}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800}
    .newBtn{background:var(--brand);border:none;color:#fff;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .selectWrap{padding:10px 14px;border-bottom:1px solid var(--border)}
    select, input[type="email"]{width:100%;background:#0d121f;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px}
    .chats{overflow:auto;padding:10px;display:flex;gap:10px;flex-wrap:wrap} /* horizontal like ChatGPT */
    .chatTag{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#121622;color:#cdd6f4;font-size:13px;cursor:pointer;white-space:nowrap;max-width:100%;text-overflow:ellipsis;overflow:hidden}
    .chatTag.active{background:#1a2030;border-color:#2a2f41}
    .sideFooter{margin-top:auto;padding:12px 14px;border-top:1px solid var(--border);font-size:13px;color:var(--muted);display:flex;align-items:center;justify-content:space-between}
    .userMenuBtn{background:transparent;border:1px solid var(--border);color:#cdd6f4;padding:8px 12px;border-radius:10px;cursor:pointer}
    /* Main */
    .main{display:grid;grid-template-rows:auto 1fr auto;min-width:0}
    .header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:var(--panel2)}
    .title{font-weight:800}
    .share{background:#171c2a;border:1px solid var(--border);color:#cdd6f4;padding:8px 12px;border-radius:10px;cursor:pointer}
    .messages{padding:20px;overflow:auto}
    .bubble{max-width:820px;margin:0 auto 14px auto;padding:14px 16px;border-radius:16px;border:1px solid var(--border);line-height:1.55;word-wrap:break-word;white-space:pre-wrap}
    .assistant{background:var(--assistant)}
    .user{background:var(--user)}
    .row{display:flex;gap:10px;align-items:flex-start}
    .row.user{justify-content:flex-end}
    .avatar{width:28px;height:28px;border-radius:8px;background:#20263a;border:1px solid #2a2f41;display:flex;align-items:center;justify-content:center;font-size:14px;flex:0 0 28px}
    .composer{padding:10px 18px;border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(20,21,29,.8),rgba(20,21,29,1))}
    .composeWrap{max-width:900px;margin:0 auto;display:flex;gap:10px;align-items:flex-end}
    textarea{flex:1;resize:none;max-height:40vh;height:54px;padding:12px 14px;border-radius:14px;background:#0f1322;border:1px solid var(--border);color:var(--text);font:inherit}
    .toolRow{display:flex;gap:8px}
    .btn{background:var(--brand);border:none;color:#fff;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .iconBtn{background:#151a28;border:1px solid var(--border);color:#cdd6f4;border-radius:12px;padding:12px;cursor:pointer}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .hidden{display:none !important}
    .preview{max-width:200px;border:1px dashed var(--border);border-radius:12px;padding:8px;background:#0f1322}
    .limitBar{max-width:900px;margin:8px auto 0 auto;background:#10162a;border:1px solid #223; border-radius:10px;color:#9db3ff;padding:8px 10px;font-size:13px;display:none}
    .upgrade{color:#9db3ff;text-decoration:underline;cursor:pointer}
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#111827;border:1px solid #2a2f41;border-radius:16px;padding:22px;max-width:420px;width:92%;text-align:center}
    .kbd{background:#0b0f1a;border:1px solid #223;border-radius:6px;padding:1px 6px;font-size:12px}
    @media(max-width:980px){.app{grid-template-columns:1fr}.side{display:none}}
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="side" id="sidebar">
      <div class="top">
        <div class="brand">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 3l7.8 4.5v9L12 21 4.2 16.5v-9L12 3z" stroke="#6b7cff"/></svg>
          Math GPT
        </div>
        <button class="newBtn" id="newChat">New Chat</button>
      </div>
      <div class="selectWrap">
        <label style="font-size:12px;color:#98a3b7">Assistant</label>
        <select id="assistantSelect">
          <option>Math GPT</option>
          <option>Content GPT</option>
          <option>MarketResearch GPT</option>
        </select>
      </div>
      <div class="selectWrap">
        <label style="font-size:12px;color:#98a3b7">Your Email (for limits & subscription)</label>
        <input type="email" id="emailInput" placeholder="you@example.com" />
      </div>
      <div class="chats" id="chatTabs"></div>
      <div class="sideFooter">
        <div id="userBadge">Signed out</div>
        <button class="userMenuBtn" id="userMenu">Menu</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="header">
        <div class="title" id="pageTitle">Chat ‚Äî <span id="assistantName">Math GPT</span></div>
        <button class="share" id="shareBtn">Share</button>
      </header>

      <div class="limitBar" id="limitBar"></div>

      <section class="messages" id="messages">
        <!-- conversation renders here -->
        <div class="bubble assistant">
          <div class="row">
            <div class="avatar">ü§ñ</div>
            <div>
              <b>Welcome!</b> Type a math problem or <span class="kbd">üì∑</span> upload a photo. Free users can solve <b>3</b> problems per day. Upgrade anytime for unlimited.
            </div>
          </div>
        </div>
      </section>

      <section class="composer">
        <div class="composeWrap">
          <button class="iconBtn" id="photoBtn" title="Upload photo">üì∑</button>
          <input class="hidden" id="photoInput" type="file" accept="image/*" />
          <div id="photoPreview" class="preview hidden"></div>
          <textarea id="prompt" rows="1" placeholder="Message Math GPT"></textarea>
          <div class="toolRow">
            <button class="iconBtn" id="clearBtn" title="New chat">üóëÔ∏è</button>
            <button class="btn" id="sendBtn" title="Send (Enter)">Send</button>
          </div>
        </div>
        <div class="hint">Press <span class="kbd">Enter</span> to send ‚Ä¢ <span class="kbd">Shift+Enter</span> for a new line</div>
      </section>
    </main>
  </div>

  <!-- Upgrade Modal -->
  <div id="upgradeModal" class="modalBackdrop hidden">
    <div class="modal">
      <h2 style="margin:0 0 6px">Free Limit Reached</h2>
      <p style="color:#cfd6ea;margin:0 0 14px">You‚Äôve solved your 3 problems for today. Upgrade to unlock unlimited step-by-step solutions.</p>
      <button class="btn" id="goUpgrade">Upgrade Now</button>
      <div style="margin-top:10px">
        <button class="userMenuBtn" id="closeUpgrade">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- State ----------
    const el = (id)=>document.getElementById(id);
    const messagesEl = el('messages');
    const promptEl = el('prompt');
    const sendBtn = el('sendBtn');
    const photoBtn = el('photoBtn');
    const photoInput = el('photoInput');
    const photoPreview = el('photoPreview');
    const clearBtn = el('clearBtn');
    const newChatBtn = el('newChat');
    const chatTabs = el('chatTabs');
    const assistantSelect = el('assistantSelect');
    const assistantNameEl = el('assistantName');
    const pageTitleEl = el('pageTitle');
    const limitBar = el('limitBar');
    const emailInput = el('emailInput');
    const userBadge = el('userBadge');
    const shareBtn = el('shareBtn');

    const upgradeModal = el('upgradeModal');
    const goUpgrade = el('goUpgrade');
    const closeUpgrade = el('closeUpgrade');

    // Persistent basic user data
    let assistantName = localStorage.getItem('assistantName') || 'Math GPT';
    assistantSelect.value = assistantName;
    assistantNameEl.textContent = assistantName;
    promptEl.placeholder = 'Message ' + assistantName;

    let email = localStorage.getItem('userEmail') || '';
    if(email) emailInput.value = email;

    // Chat sessions in localStorage
    let chats = JSON.parse(localStorage.getItem('chats') || '[]');
    let currentChatId = localStorage.getItem('currentChatId') || createChat(); // ensure one chat exists
    renderChatTabs();

    // Free gating
    const today = new Date().toISOString().split('T')[0];
    let solveCount = Number(localStorage.getItem('dailySolves') || 0);
    let lastUsed = localStorage.getItem('lastSolveDate') || '';
    if (lastUsed !== today) { solveCount = 0; localStorage.setItem('dailySolves', 0); localStorage.setItem('lastSolveDate', today); }

    // ---------- Helpers ----------
    function saveChats(){ localStorage.setItem('chats', JSON.stringify(chats)); }
    function setCurrentChat(id){ currentChatId = id; localStorage.setItem('currentChatId', id); }
    function activeChat(){ return chats.find(c=>c.id===currentChatId); }
    function createChat() {
      const id = 'c_' + Math.random().toString(36).slice(2,9);
      const chat = { id, title:'New Chat', messages:[] };
      chats.unshift(chat);
      saveChats();
      localStorage.setItem('currentChatId', id);
      return id;
    }
    function renameCurrentChatFrom(text){
      const ch = activeChat(); if(!ch) return;
      if(ch.title==='New Chat' && text.trim()){
        ch.title = (text.trim().slice(0,42) || 'Untitled');
        saveChats(); renderChatTabs();
      }
    }
    function renderChatTabs(){
      chatTabs.innerHTML = '';
      chats.forEach(c=>{
        const tag = document.createElement('div');
        tag.className = 'chatTag' + (c.id===currentChatId?' active':'');
        tag.title = c.title;
        tag.textContent = c.title;
        tag.onclick = ()=>{ setCurrentChat(c.id); loadChatToUI(); renderChatTabs(); };
        chatTabs.appendChild(tag);
      });
    }
    function loadChatToUI(){
      messagesEl.innerHTML = '';
      const ch = activeChat(); if(!ch) return;
      if(ch.messages.length===0){
        addAssistant('What can I help you solve today?');
        return;
      }
      ch.messages.forEach(m=>{
        if(m.role==='user') addUser(m.content, m.imageData);
        else addAssistant(m.content);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function addAssistant(text){
      const wrap = document.createElement('div'); wrap.className = 'bubble assistant';
      wrap.innerHTML = `<div class="row"><div class="avatar">ü§ñ</div><div>${renderMarkdownLight(text)}</div></div>`;
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function addUser(text, imageData){
      const wrap = document.createElement('div'); wrap.className = 'bubble user';
      const img = imageData ? `<div style="margin:6px 0"><img src="${imageData}" style="max-width:280px;border-radius:10px;border:1px solid var(--border)"/></div>` : '';
      wrap.innerHTML = `<div class="row user"><div><div style="text-align:right">${escapeHtml(text)}</div>${img}</div><div class="avatar">üßë</div></div>`;
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    // Minimal markdown: headers & code blocks & bold/italic
    function renderMarkdownLight(s){
      if(!s) return '';
      let t = s
        .replace(/^### (.*$)/gim,'<h3>$1</h3>')
        .replace(/^## (.*$)/gim,'<h2>$1</h2>')
        .replace(/^# (.*$)/gim,'<h1>$1</h1>')
        .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
        .replace(/\*(.+?)\*/g,'<i>$1</i>');
      // code fences
      t = t.replace(/```([\s\S]*?)```/g, (_,code)=>`<pre style="background:#0b0f1a;border:1px solid #223;border-radius:10px;padding:10px;overflow:auto"><code>${escapeHtml(code)}</code></pre>`);
      return t.replace(/\n/g,'<br/>');
    }

    function showLimitBar(text){
      limitBar.textContent = text;
      limitBar.style.display = 'block';
    }
    function hideLimitBar(){ limitBar.style.display = 'none'; }

    function showUpgrade(){
      upgradeModal.classList.remove('hidden');
    }
    function closeUpgradeModal(){
      upgradeModal.classList.add('hidden');
    }

    async function getSubscriptionStatus() {
      // Ensure email
      if(!email){
        email = prompt("Enter your email to continue:") || '';
        if(email){ localStorage.setItem('userEmail', email); emailInput.value = email; }
      }
      userBadge.textContent = email ? ('Signed in: ' + email) : 'Signed out';
      if(!email) return 'free';
      try{
        const r = await fetch(`/api/subscription/status/${encodeURIComponent(email)}`);
        const j = await r.json();
        return j.status || 'free';
      }catch(e){
        console.warn('status check failed', e);
        return 'free';
      }
    }

    async function canProceedSolve(){
      const status = await getSubscriptionStatus();
      if(status === 'active'){
        hideLimitBar();
        return true;
      }
      // free user
      if(solveCount >= 3){
        showLimitBar(`You've used 3/3 free solves today. `);
        showUpgrade();
        return false;
      }
      // increment now; server may also enforce
      solveCount++;
      localStorage.setItem('dailySolves', solveCount);
      showLimitBar(`Free solves: ${solveCount}/3 used today. <span class="upgrade" id="upgradeLink">Upgrade</span>`);
      setTimeout(()=>{
        const link = document.querySelector('#upgradeLink');
        if(link) link.onclick = ()=>{ window.location.href = '/#pricing'; };
      },0);
      return true;
    }

    function toDataUrl(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // ---------- Send Flow ----------
    async function sendPrompt(){
      const text = promptEl.value.trim();
      const ch = activeChat();
      const imageData = photoPreview.dataset.src || null;
      if(!text && !imageData) return;

      // UI append user
      addUser(text || (imageData ? '(Photo solve)' : ''), imageData);
      ch.messages.push({ role:'user', content:text, imageData });
      renameCurrentChatFrom(text || 'Photo');
      saveChats(); renderChatTabs();

      // Clear composer
      promptEl.value = '';
      photoPreview.classList.add('hidden');
      photoPreview.dataset.src = '';

      // Typing indicator
      const typing = document.createElement('div');
      typing.className = 'bubble assistant';
      typing.innerHTML = `<div class="row"><div class="avatar">ü§ñ</div><div><i>Thinking‚Ä¶</i></div></div>`;
      messagesEl.appendChild(typing);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      try{
        const payload = {
          email: email || null,
          assistant: assistantName,
          message: text || null,
          image: imageData || null
        };
        const res = await fetch('/api/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        typing.remove();
        if(!res.ok){
          addAssistant(`**Error:** ${json?.error || 'Request failed'}`);
          ch.messages.push({ role:'assistant', content:`Error: ${json?.error || 'Request failed'}` });
          saveChats();
          return;
        }
        const answer = json?.content || json?.answer || '(No response)';
        addAssistant(answer);
        ch.messages.push({ role:'assistant', content: answer });
        saveChats();
      }catch(err){
        typing.remove();
        addAssistant('**Network error.** Please try again.');
        const ch = activeChat();
        ch.messages.push({ role:'assistant', content:'Network error.' });
        saveChats();
      }
    }

    // ---------- Events ----------
    assistantSelect.addEventListener('change', ()=>{
      assistantName = assistantSelect.value;
      localStorage.setItem('assistantName', assistantName);
      assistantNameEl.textContent = assistantName;
      promptEl.placeholder = 'Message ' + assistantName;
      pageTitleEl.textContent = 'Chat ‚Äî ' + assistantName;
    });

    emailInput.addEventListener('change', ()=>{
      email = emailInput.value.trim();
      localStorage.setItem('userEmail', email);
      userBadge.textContent = email ? ('Signed in: ' + email) : 'Signed out';
    });

    newChatBtn.addEventListener('click', ()=>{
      setCurrentChat(createChat());
      renderChatTabs();
      loadChatToUI();
    });

    clearBtn.addEventListener('click', ()=>{
      setCurrentChat(createChat());
      renderChatTabs();
      loadChatToUI();
      promptEl.focus();
    });

    sendBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      if(await canProceedSolve()) await sendPrompt();
    });

    promptEl.addEventListener('keydown', async (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        if(await canProceedSolve()) await sendPrompt();
      }
    });

    photoBtn.addEventListener('click', ()=> photoInput.click());
    photoInput.addEventListener('change', async ()=>{
      const f = photoInput.files?.[0];
      if(!f) return;
      const dataUrl = await toDataUrl(f);
      photoPreview.classList.remove('hidden');
      photoPreview.dataset.src = dataUrl;
      photoPreview.innerHTML = `<img src="${dataUrl}" style="max-width:180px;border-radius:8px;display:block;margin:0 auto 6px"/><div style="text-align:center;font-size:12px;color:#9aa3b2">${f.name}</div>`;
    });

    goUpgrade.addEventListener('click', ()=>{ window.location.href = '/#pricing'; });
    closeUpgrade.addEventListener('click', closeUpgradeModal);

    shareBtn.addEventListener('click', async ()=>{
      const ch = activeChat();
      const text = ch.messages.map(m=> (m.role==='user' ? 'You: ' : 'AI: ') + (m.content||'')).join('\n\n');
      try{
        await navigator.share({ title: 'Math GPT chat', text });
      }catch(_){}
    });

    // ---------- Init ----------
    (async function init(){
      // Reflect subscription status on top bar for free users
      const status = await getSubscriptionStatus();
      if(status==='active'){ hideLimitBar(); }
      else showLimitBar(`Free solves: ${solveCount}/3 used today. <span class="upgrade" id="upgradeLink">Upgrade</span>`);
      setTimeout(()=>{ const link=document.querySelector('#upgradeLink'); if(link) link.onclick=()=>{ window.location.href='/#pricing' }},0);
      loadChatToUI();
    })();
  </script>
</body>
</html>
