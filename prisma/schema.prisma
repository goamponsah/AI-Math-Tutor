// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ---------- Enums (avoid string typos) ---------- */
enum Plan {
  premium
  pro
}

enum SubscriptionStatus {
  active
  canceled
}

enum Provider {
  paystack
}

/* ---------- Models ---------- */

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  createdAt     DateTime       @default(now())
  subscriptions Subscription[]
  payments      Payment[]

  @@index([createdAt])
}

model Subscription {
  id               String              @id @default(cuid())
  userId           String
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan             Plan
  status           SubscriptionStatus
  provider         Provider            // paystack
  providerPlanCode String?
  lastPaidAt       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // used by server: upsert via { userId, plan }
  @@unique([userId, plan], name: "userId_plan")
  @@index([userId, status])
}

model Payment {
  id              String    @id @default(cuid())
  userId          String?
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  provider        Provider
  reference       String    @unique     // Paystack reference
  amountMinor     Int?
  currency        String?                 // e.g., "GHS"
  status          String                  // "initialized" | "success" | "failed"
  createdAt       DateTime  @default(now())
  rawInitResponse Json?
  rawWebhookEvent Json?

  @@index([createdAt])
  @@index([status])
}
